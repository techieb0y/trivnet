stages:
  - preflight
  - assets
  - package
  - deploy

php-lint:
  stage: preflight
  image: dockreg.corbettdigital.net/trivnet/buildenv:master
  tags:
    - docker
  script:
    - find ./ -name \*.php -exec php -l '{}' \;

get-fcc-db:
  stage: assets
  tags:
    - docker
  image: dockreg.corbettdigital.net/trivnet/buildenv:master
  script:
    - mkdir fcc
    - curl -s -o fcc/l_amat.zip http://storage.corbettdigital.net/l_amat.zip
    - unzip -d fcc/ fcc/l_amat.zip
    - mv `php util/fcc-util.php fcc/` ./fcc/
  artifacts:
    paths:
      - fcc/trivnet-fcc.out

rpmbuild:
  stage: package
  image: dockreg.corbettdigital.net/trivnet/buildenv:master
  tags:
    - docker
  script:
    - for i in SOURCES BUILD BUILDROOT SPECS RPMS; do mkdir -p rpmbuild/${i}; done
    - rsync -rv src/ rpmbuild/BUILD/trivnet/
    - rsync -rv util/ rpmbuild/BUILD/util/
    - mv httpd.conf rpmbuild/SOURCES/
    - mv fcc/trivnet-fcc.out rpmbuild/SOURCES/
    - mv trivnet.spec rpmbuild/SPECS/
    - echo "SetEnv TRIVNET-SHA ${CI_COMMIT_SHA}" > rpmbuild/BUILD/trivnet/.htaccess
    - rpmbuild --define "now `date +%s`" --define "_topdir `pwd`/rpmbuild/" -bb rpmbuild/SPECS/trivnet.spec
  artifacts:
    paths:
      - rpmbuild/RPMS/
  dependencies:
    - get-fcc-db

deploy-stage:
  stage: deploy
  tags:
    - trivnet-stage
  dependencies:
    - rpmbuild
  script:
    - sudo yum -y localinstall rpmbuild/RPMS/x86_64/trivnet*.rpm
  environment:
    name: Stage
    url: http://172.16.104.76/trivnet/

deploy-prod:
  stage: deploy
  when: manual
  tags:
    - trivnet-prod
  dependencies:
    - rpmbuild
  script:
    - sudo yum -y localinstall rpmbuild/RPMS/x86_64/trivnet*.rpm
  environment:
    name: Production
    url: http://10.145.67.1/trivnet/
            
